<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v4.js"></script>
    <title>視覺化對資料判讀之影響程度評估測驗</title>
    <style>
        body {
            font: 16px Arial;
        }

        .board {
            margin: 1rem 0;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
        }

        table,
        th,
        td {
            border: #333 1px solid;
            text-align: center;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }
    </style>
</head>

<body>
    <div class="board" id="default">
        <table>
            <tr>
                <th>花費時間</th>
                <th>數到的個數</th>
            </tr>
        </table>
        <svg class="scatter"></svg>
        <svg class="pie"></svg>
    </div>
    <div class="board" id="bold">
        <table>
            <tr>
                <th>花費時間</th>
                <th>數到的個數</th>
            </tr>
        </table>
        <svg class="scatter"></svg>
        <svg class="pie"></svg>
    </div>
    <div class="board" id="color">
        <table>
            <tr>
                <th>花費時間</th>
                <th>數到的個數</th>
            </tr>
        </table>
        <svg class="scatter"></svg>
        <svg class="pie"></svg>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const dataset = {
            default: {
                answer: 7,
                title: '無視覺提示時找出 3 的',
                table: document.querySelector('#default > table'),
                scatterPlot: null,
                pieChart: null,
                scatter: [],
                pie: {},
            },
            bold: {
                answer: 10,
                title: '有粗體提示時找出 5 的',
                table: document.querySelector('#bold > table'),
                scatterPlot: null,
                pieChart: null,
                scatter: [],
                pie: {},
            },
            color: {
                answer: 9,
                title: '有顏色提示時找出 7 的',
                table: document.querySelector('#color > table'),
                scatterPlot: null,
                pieChart: null,
                scatter: [],
                pie: {},
            },
        };

        fetch('/data')
            .then(res => res.json())
            .then(data => {
                // Setup socket
                const socket = io();
                const margin = { top: 30, right: 20, bottom: 50, left: 50 },
                    width = 600 - margin.left - margin.right,
                    height = 300 - margin.top - margin.bottom,
                    radius = height / 2;

                const x = d3.scaleLinear().domain([0, 20]).range([0, width]);
                const y = d3.scaleLinear().domain([0, 15]).range([height, 0]);
                const arcGenerator = d3.arc().innerRadius(0).outerRadius(radius)

                // Setup existing dataset
                Object.keys(data).forEach(category => {
                    dataset[category].scatter = data[category];
                    dataset[category].scatter.forEach(record => {
                        addTableRow(dataset[category].table, record);
                        if (record.count === dataset[category].answer) {
                            if (dataset[category].pie['正確'])
                                ++dataset[category].pie['正確'];
                            else
                                dataset[category].pie['正確'] = 1;
                        }
                        else {
                            if (dataset[category].pie['不正確'])
                                ++dataset[category].pie['不正確'];
                            else
                                dataset[category].pie['不正確'] = 1;
                        }
                    });
                    setupBoard(category)
                })

                function setupBoard(category) {
                    // Adds the scatter plot canvas
                    dataset[category].scatterPlot = d3.select(`#${category} > .scatter`)
                        .attr('width', width + margin.left + margin.right)
                        .attr('height', height + margin.top + margin.bottom)
                        .append('g')
                        .attr('transform', `translate(${margin.left},${margin.top})`);

                    // Add scatter plot axis
                    dataset[category].scatterPlot.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x));
                    dataset[category].scatterPlot.append('g').call(d3.axisLeft(y));

                    // Add title and axis label
                    dataset[category].scatterPlot.append('text')
                        .attr('x', (width / 2))
                        .attr('y', 0 - (margin.top / 2))
                        .attr('text-anchor', 'middle')
                        .style('font-size', '16px')
                        .text(dataset[category].title + '所需時間');

                    dataset[category].scatterPlot.append('text')
                        .attr('x', 0 - (height / 2))
                        .attr('y', 0 - (margin.left / 2))
                        .attr('text-anchor', 'middle')
                        .style('font-size', '16px')
                        .style('transform', 'rotate(270deg)')
                        .text('數到的個數');

                    dataset[category].scatterPlot.append('text')
                        .attr('x', (width / 2))
                        .attr('y', height + (margin.bottom * 0.75))
                        .attr('text-anchor', 'middle')
                        .style('font-size', '16px')
                        .text('花費時間');

                    // Add data dot
                    addDot(category);

                    // Adds the pie chart canvas
                    dataset[category].pieChart = d3.select(`#${category} > .pie`)
                        .attr('width', radius * 2 + 2)
                        .attr('height', radius * 2 + 2 + margin.top)
                        .append('g')
                        .attr('transform', `translate(${radius + 1},${radius + 1 + margin.top})`);

                    buildPie(category);

                    // Add socket handler
                    socket.on(category, record => {
                        dataset[category].scatter.push(record);
                        if (record.count === dataset[category].answer) {
                            if (dataset[category].pie['正確'])
                                ++dataset[category].pie['正確'];
                            else
                                dataset[category].pie['正確'] = 1;
                        }
                        else {
                            if (dataset[category].pie['不正確'])
                                ++dataset[category].pie['不正確'];
                            else
                                dataset[category].pie['不正確'] = 1;
                        }
                        addRecord(category);
                    });
                }

                function addRecord(category) {
                    addTableRow(dataset[category].table, dataset[category].scatter[dataset[category].scatter.length - 1])
                    addDot(category);
                    buildPie(category);
                }

                function addTableRow(table, data) {
                    table.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${data.time}</td>
                        <td>${data.count}</td>
                    </tr>
                    `.trim())
                }

                function addDot(category) {
                    dataset[category].scatterPlot
                        .append('g')
                        .selectAll('dot')
                        .data(dataset[category].scatter).enter()
                        .append('circle')
                        .attr('cx', d => x(d.time))
                        .attr('cy', d => y(d.count))
                        .attr('r', 3)
                        .style('fill', d => d.count == dataset[category].answer ? '#FF6666' : '#6666FF')
                }

                function buildPie(category) {
                    const pie = d3.pie().value(d => d.value);
                    const pieData = pie(d3.entries(dataset[category].pie));

                    dataset[category].pieChart.selectAll('path').remove();
                    dataset[category].pieChart.selectAll('text').remove();

                    dataset[category].pieChart.append('text')
                        .attr('x', 0)
                        .attr('y', 0 - radius - (margin.top / 2))
                        .attr('text-anchor', 'middle')
                        .style('font-size', '16px')
                        .text(dataset[category].title + '正確率');

                    dataset[category].pieChart
                        .selectAll('.slices')
                        .attr('class', 'slices')
                        .data(pieData).enter()
                        .append('path')
                        .attr('d', arcGenerator)
                        .attr('fill', d => d.data.key == '正確' ? '#FF6666' : '#6666FF')
                        .attr('stroke', 'black')
                        .style('stroke-width', '2px')
                        .style('opacity', 0.7);

                    dataset[category].pieChart
                        .selectAll('.slices')
                        .attr('class', 'slices')
                        .data(pieData).enter()
                        .append('text')
                        .text(d => `${d.data.key}, ${Math.round((d.data.value / dataset[category].scatter.length) * 100)}%`)
                        .attr('transform', d => `translate(${arcGenerator.centroid(d)})`)
                        .style('text-anchor', 'middle')
                        .style('font-size', 16);
                }
            });
    </script>
</body>

</html>